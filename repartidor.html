<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Panel Repartidor | Servicio PyME (Mobile)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <!-- Top Bar -->
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <a href="./index.html" class="shrink-0 inline-flex items-center justify-center w-9 h-9 rounded-xl bg-indigo-50 text-indigo-600 font-bold">S</a>
          <div>
            <h1 class="text-lg sm:text-xl font-bold text-slate-800">Repartidor</h1>
            <p class="text-xs text-slate-500 -mt-0.5">Panel de asignación y rutas</p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <a href="./empresa.html" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Empresa</a>
          <a href="./tracking_cliente.html" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm">Tracking cliente</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto px-4 py-4 sm:py-6 space-y-4 sm:space-y-6">

    <!-- Filtros / Header -->
    <section class="bg-white rounded-2xl shadow-sm p-4 sm:p-6 border border-slate-200">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-600">Repartidor:</span>
          <select id="selRepartidor" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm"></select>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnTabDisponibles" class="px-3 py-2 rounded-xl text-sm bg-indigo-50 text-indigo-700 border border-indigo-100">Pedidos disponibles</button>
          <button id="btnTabMisPedidos" class="px-3 py-2 rounded-xl text-sm bg-slate-100 hover:bg-slate-200">Mis pedidos</button>
        </div>
      </div>
    </section>

    <!-- Disponibles -->
    <section id="tabDisponibles" class="bg-white rounded-2xl shadow-sm p-4 sm:p-6 border border-slate-200">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-3">
        <h2 class="text-base sm:text-lg font-semibold text-slate-800">Pedidos disponibles</h2>
        <div class="flex w-full sm:w-auto gap-2">
          <input id="fEmpresa" class="flex-1 min-w-0 px-3 py-3 border border-slate-200 rounded-xl" placeholder="Filtrar por empresa (opcional)" />
          <button id="btnBuscarDisponibles" class="px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 active:scale-[.99]">
            Buscar
          </button>
        </div>
      </div>
      <div id="listaDisponibles" class="space-y-3"></div>
      <p id="emptyDisponibles" class="text-sm text-slate-500 hidden">No hay pedidos disponibles.</p>
    </section>

    <!-- Mis pedidos -->
    <section class="bg-white rounded-2xl shadow-sm p-4 sm:p-6 border border-slate-200">
      <div class="flex items-center justify-between mb-3 gap-2">
        <h2 class="text-base sm:text-lg font-semibold text-slate-800">Mis pedidos</h2>
        <div class="flex items-center gap-2">
          <div class="text-xs text-slate-500">Estado:</div>
          <select id="selEstadoMisPedidos" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm">
            <option value="">Todos</option>
            <option value="ASIGNADO">ASIGNADO</option>
            <option value="EN RUTA">EN RUTA</option>
            <option value="ENTREGADO">ENTREGADO</option>
          </select>
          <button id="btnRefresh"
                  class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm">Actualizar</button>
        </div>
      </div>
      <div id="listaMisPedidos" class="space-y-3"></div>
      <p id="emptyMisPedidos" class="text-sm text-slate-500 hidden">No tienes pedidos asignados.</p>
    </section>

  </main>

  <!-- Modal RUTA -->
  <div id="routeModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] hidden">
    <div class="absolute inset-0 flex items-end sm:items-center justify-center">
      <div class="w-full sm:w-[680px] bg-white rounded-t-2xl sm:rounded-2xl sm:shadow-xl overflow-hidden h-[92vh] sm:h-auto">
        <div class="px-4 sm:px-5 py-4 border-b flex items-center justify-between">
          <h3 class="text-base sm:text-lg font-semibold text-slate-800">Ruta recomendada</h3>
          <button class="text-slate-500 hover:text-slate-700 text-lg" onclick="closeRouteModal()">✕</button>
        </div>

        <div class="p-4 sm:p-5 space-y-4 h-[calc(92vh-64px)] sm:h-auto overflow-y-auto">
          <div class="text-sm text-slate-700 grid grid-cols-1 sm:grid-cols-3 gap-2">
            <div><span class="font-medium">Cliente:</span> <span id="rmCliente">—</span></div>
            <div class="sm:col-span-2"><span class="font-medium">Destino:</span> <span id="rmDestino">—</span></div>
            <div><span class="font-medium">Fecha:</span> <span id="rmFecha">—</span></div>
            <div><span class="font-medium">Hora:</span> <span id="rmHora">—</span></div>
            <div id="rmOrigenWrap" class="hidden sm:col-span-3"><span class="font-medium">Origen:</span> <span id="rmOrigen">Mi ubicación</span></div>
          </div>

          <div class="rounded-xl border overflow-hidden">
            <iframe id="rmMap"
                    src=""
                    width="100%" height="360" style="border:0;"
                    loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>

          <div class="flex gap-2">
            <a id="btnOpenGmaps" href="#" target="_blank" class="flex-1 px-4 py-3 rounded-xl bg-indigo-600 text-white text-center">Abrir en Google Maps</a>
            <a id="btnOpenWaze" href="#" target="_blank" class="flex-1 px-4 py-3 rounded-xl bg-slate-800 text-white text-center">Abrir en Waze</a>
            <button class="px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200" onclick="closeRouteModal()">Cerrar</button>
          </div>

          <p class="text-xs text-slate-500">
            Si no otorgas permiso de ubicación, la ruta usará tu ubicación por defecto del mapa.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ====== Config Supabase ======
    const SUPABASE_URL = "https://krczqimvyjvntwivwfzp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyY3pxaW12eWp2bnR3aXZ3ZnpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTk5OTc2NzksImV4cCI6MjAxNTU3MzY3OX0.4w95kN7X0rKbaqKkM7Kz8mAqR5fYjKfMS3K8d2pNfN0";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== State ======
    let repartidoresCache = [];
    let repartidorSel = null;
    let disponiblesCache = [];
    const qs = (id) => document.getElementById(id);

    // === Helpers de fecha/hora ===
    function fmtDate(s){ try{ if(!s) return '—'; const d=new Date(s); return d.toLocaleDateString(); }catch(e){ return '—'; } }
    function fmtTime(s){ try{ if(!s) return '—'; const d=new Date(s); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }catch(e){ return '—'; } }

    // ====== Repartidores ======
    async function cargarRepartidores(){
      const { data, error } = await supabaseClient
        .from('repartidores_demo')
        .select('*')
        .order('nombre', { ascending: true });
      if (error) { console.error(error); return; }
      repartidoresCache = data || [];
      const sel = qs('selRepartidor');
      sel.innerHTML = (repartidoresCache||[]).map(r=>`<option value="${r.id}">${r.nombre}</option>`).join('');
      repartidorSel = sel.value ? parseInt(sel.value,10) : null;
    }

    // Render card de pedido
    function cardPedido(p, accionesHTML){
      const fragil = p.es_fragil ? `<span class="ml-2 text-[11px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700">Frágil</span>` : "";
      return `
        <div class="rounded-xl border p-3 sm:p-4 bg-white">
          <div class="flex items-center justify-between gap-2">
            <span class="font-semibold text-indigo-700"># ${p.id}</span>
            <span class="text-[11px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">${p.estado_pedido}</span>
          </div>
          <div class="mt-2 text-sm text-slate-700 space-y-1">
            <div><b>Empresa:</b> ${p.empresa_solicitante || "—"}</div>
            <div><b>Cliente:</b> ${p.nombre_cliente || "—"}</div>
            <div><b>Dirección:</b> ${p.direccion_entrega || "—"}</div>
            <div><b>Paquetes:</b> ${p.cantidad_paquetes} ${fragil}</div>
            <div><b>Celular:</b> ${p.numero_celular ? `<a href="tel:${p.numero_celular}" class="text-indigo-700 underline">${p.numero_celular}</a>` : "—"}</div>
            <div><b>Creado:</b> ${fmtDate(p.creado_en)} · ${fmtTime(p.creado_en)}</div>
          </div>
          <div class="mt-3 grid grid-cols-2 sm:flex sm:flex-row gap-2">${accionesHTML}</div>
        </div>
      `;
    }

    // ====== Disponibles ======
    async function cargarDisponibles(){
      const f = qs("fEmpresa").value.trim();
      let query = supabaseClient
        .from('deliveries_demo')
        .select('*')
        .or('estado_pedido.eq.NUEVO,estado_pedido.eq.APROBADO')
        .is('repartidor_id', null)
        .order('creado_en', { ascending: false });

      if (f) query = query.ilike('empresa_solicitante', `%${f}%`);
      const { data, error } = await query;
      if (error) { console.error(error); return; }
      disponiblesCache = data || [];
      renderDisponibles();
    }

    function renderDisponibles(){
      const cont = qs('listaDisponibles');
      cont.innerHTML = '';
      if (!disponiblesCache?.length){
        qs('emptyDisponibles').classList.remove('hidden');
        return;
      }
      qs('emptyDisponibles').classList.add('hidden');

      cont.innerHTML = disponiblesCache.map(p=>{
        const acciones = `
          <a href="javascript:void(0)" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm"
             onclick='showRouteModal(${JSON.stringifyForHtml ? JSON.stringifyForHtml(p) : JSON.stringify(p)})'>Ver ruta</a>
          <button class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm"
             onclick="tomarPedido(${p.id})">Tomar pedido</button>`;
        return cardPedido(p, acciones);
      }).join('');
    }

    // ====== Mis pedidos ======
    async function cargarMisPedidos(){
      const estado = qs('selEstadoMisPedidos').value;
      let q = supabaseClient
        .from('deliveries_demo')
        .select('*')
        .eq('repartidor_id', repartidorSel)
        .order('creado_en', { ascending: false });

      if (estado) q = q.eq('estado_pedido', estado);

      const { data, error } = await q;
      if (error) { console.error(error); return; }
      const pedidos = data || [];
      const cont = qs('listaMisPedidos');
      cont.innerHTML = '';
      if (!pedidos.length){
        qs('emptyMisPedidos').classList.remove('hidden');
        return;
      }
      qs('emptyMisPedidos').classList.add('hidden');

      cont.innerHTML = pedidos.map(p=>{
        const acciones = `
          <a href="javascript:void(0)" class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm"
             onclick='showRouteModal(${JSON.stringifyForHtml ? JSON.stringifyForHtml(p) : JSON.stringify(p)})'>Ver ruta</a>
          <button class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm"
             onclick="marcarEnRuta(${p.id})">Marcar EN RUTA</button>
          <button class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm"
             onclick="marcarEntregado(${p.id})">Marcar ENTREGADO</button>`;
        return cardPedido(p, acciones);
      }).join('');
    }

    // ====== Acciones ======
    async function tomarPedido(id){
      if (!repartidorSel) return alert('Seleccione un repartidor');
      const { error } = await supabaseClient
        .from('deliveries_demo')
        .update({ repartidor_id: repartidorSel, estado_pedido: 'ASIGNADO' })
        .eq('id', id);
      if (error) return alert('Error al tomar pedido');
      await cargarDisponibles();
      await cargarMisPedidos();
    }

    async function marcarEnRuta(id){
      const { error } = await supabaseClient
        .from('deliveries_demo').update({ estado_pedido: 'EN RUTA' }).eq('id', id);
      if (error) return alert('Error');
      await cargarMisPedidos();
    }

    async function marcarEntregado(id){
      const { error } = await supabaseClient
        .from('deliveries_demo').update({ estado_pedido: 'ENTREGADO' }).eq('id', id);
      if (error) return alert('Error');
      await cargarMisPedidos();
    }

    // ====== Modal ======
    function showRouteModal(p){
      const d = p.direccion_entrega;
      qs('rmCliente').textContent = p.nombre_cliente || "—";
      qs('rmDestino').textContent = d || "—";
      qs('rmFecha').textContent = fmtDate(p.creado_en);
      qs('rmHora').textContent  = fmtTime(p.creado_en);
      qs('rmMap').src = `https://www.google.com/maps?q=${encodeURIComponent(d)}&output=embed`;
      let gm = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(d)}&travelmode=driving`;
      let wz = `https://waze.com/ul?q=${encodeURIComponent(d)}&navigate=yes`;
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude,longitude} = pos.coords;
          qs('rmOrigenWrap').classList.remove('hidden');
          qs('rmOrigen').textContent = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
          gm = `https://www.google.com/maps/dir/?api=1&origin=${latitude},${longitude}&destination=${encodeURIComponent(d)}&travelmode=driving`;
          wz = `https://waze.com/ul?ll=${latitude},${longitude}&navigate=yes`;
          qs('btnOpenGmaps').href = gm; qs('btnOpenWaze').href = wz;
        },()=>{qs('btnOpenGmaps').href=gm;qs('btnOpenWaze').href=wz;},{enableHighAccuracy:true,timeout:5000});
      } else { qs('btnOpenGmaps').href=gm; qs('btnOpenWaze').href=wz; }
      document.getElementById('routeModal').classList.remove('hidden');
    }
    function closeRouteModal(){
      document.getElementById('routeModal').classList.add('hidden');
      qs('rmMap').src = '';
      qs('rmOrigenWrap').classList.add('hidden');
    }

    // ====== Tabs y eventos ======
    document.getElementById('btnTabDisponibles').addEventListener('click',()=>{
      document.getElementById('tabDisponibles').classList.remove('hidden');
    });
    document.getElementById('btnTabMisPedidos').addEventListener('click',()=>{
      cargarMisPedidos();
      document.getElementById('tabDisponibles').classList.add('hidden');
    });

    document.getElementById('btnBuscarDisponibles').addEventListener('click', cargarDisponibles);
    document.getElementById('btnRefresh').addEventListener('click', cargarMisPedidos);
    document.getElementById('selEstadoMisPedidos').addEventListener('change', cargarMisPedidos);
    document.getElementById('selRepartidor').addEventListener('change', (e)=> {
      repartidorSel = parseInt(e.target.value,10);
      cargarMisPedidos();
    });

    // ====== Init ======
    (async ()=>{
      await cargarRepartidores();
      await cargarDisponibles();
      await cargarMisPedidos();
    })();

    // Helper para embebido seguro (si existía en tu proyecto)
    if (!window.JSON.stringifyForHtml) {
      JSON.stringifyForHtml = (obj)=> JSON.stringify(obj).replace(/</g,"\\u003c");
    }
  </script>
</body>
</html>
